name: CI/CD - Build and Deploy to Minikube

# This tells GitHub *when* to run this workflow
on:
  push:
    branches: ["main"]

# This defines the "jobs" (tasks) to run
jobs:
  # -------------------------------------------------
  # JOB 1: BUILD (Runs in the Cloud)
  # -------------------------------------------------
  build:
    name: Build and Push to Docker Hub
    # Run this job on GitHub's cloud server
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # This build will be tagged as "latest"
          tags: your-username/clinic-management-api:latest # <--- MAKE SURE THIS IS YOUR USERNAME

  # -------------------------------------------------
  # JOB 2: DEPLOY (Runs on YOUR Laptop)
  # -------------------------------------------------
  deploy:
    name: Deploy to Minikube
    # This job *must* wait for the 'build' job to finish
    needs: build

    # This tells GitHub to send this job to YOUR runner
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Deploy to Minikube
        # This command runs right on your laptop!
        run: |
          echo "Starting deployment to Minikube..."
          kubectl apply -f .
          echo "Deployment applied. Waiting for pods to roll out..."
          kubectl rollout status deployment/clinic-management-api-deployment
          echo "Deployment complete!"
